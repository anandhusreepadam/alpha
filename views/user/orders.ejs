<%-include("../../views/partials/user/header")%>

    <head>
        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="description" content="" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta property="og:title" content="" />
        <meta property="og:type" content="" />
        <meta property="og:url" content="" />
        <meta property="og:image" content="" />

        <link href="assets/css/main.css?v=1.1" rel="stylesheet" type="text/css" />
        <style>
            .content-main {
                background: none;
                box-shadow: none;
                border: none;
            }

            .content-body {
                padding: 20px;
                background-color: #f8f9fa;
                border-radius: 10px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }

            h2.section-title {
                font-size: 24px;
                margin-bottom: 20px;
                color: #343a40;
                font-weight: 600;
            }

            .order-card {
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 20px;
                background-color: #ffffff;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s, box-shadow 0.3s;
            }

            .order-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            }

            .order-card h5 {
                font-size: 18px;
                font-weight: 600;
                margin-bottom: 10px;
            }

            .order-card p {
                font-size: 14px;
                color: #555;
            }

            .btn-view {
                background-color: #007bff;
                color: #fff;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer;
                transition: all 0.3s ease-in-out;
            }

            .btn-view:hover {
                background-color: #0056b3;
            }
        </style>
    </head>
    <body>
        <div class="spacer">
        </div>
        <section class="content-main">
            <div class="content-header">
                <h2 class="content-title">Manage Orders</h2>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row gx-5">
                        <aside class="col-lg-3 border-end">
                            <nav class="nav nav-pills flex-lg-column mb-4">
                                <a class="nav-link" href="/profile">General</a>
                                <a class="nav-link" href="/address">Address</a>
                                <a class="nav-link active" aria-current="page" href="/orders">Orders</a>
                                <a class="nav-link" href="#">Wallet</a>
                            </nav>
                        </aside>
                        <div class="col-lg-9">
                            <section class="content-body">
                                <h2 class="section-title">Your Orders</h2>
                                <% if (orders && orders.length > 0) { %>
                                    <% orders.forEach(order => { %>
                                        <div class="order-card">
                                            <!-- Order Header -->
                                            <div class="order-header">
                                                <h5>Order ID: <%= order.orderId %></h5>
                                                <p>Date: <%= new Date(order.createdAt).toLocaleDateString() %></p>
                                            </div>
                        
                                            <!-- Order Details -->
                                            <div class="order-details">
                                                <p>Status: <span class="order-status"><%= order.status %></span></p>
                                                <p>Total: â‚¹<%= order.finalAmount %></p>
                                            </div>
                        
                                            <!-- Shipping Address -->
                                            <div class="order-address">
                                                <p><strong>Shipping Address:</strong></p>
                                                <p>
                                                    <%= order.address.name %>, <%= order.address.address %>, 
                                                    <%= order.address.city %>, <%= order.address.state %> - 
                                                    <%= order.address.pincode %>
                                                </p>
                                                <p>Phone: <%= order.address.phone %></p>
                                            </div>
                        
                                            <!-- Action Buttons -->
                                            <div class="order-actions">
                                                <% if (order.status === 'Delivered') { %>
                                                    <!-- Return Button -->
                                                    <button 
                                                        class="btn btn-primary" 
                                                        onclick="returnOrder('<%= order._id %>')">
                                                        Return
                                                    </button>
                                                <% } else { %>
                                                    <!-- Cancel Button -->
                                                    <button 
                                                        class="btn btn-danger" 
                                                        onclick="cancelOrder('<%= order._id %>')" 
                                                        <%= order.status === 'Cancelled'? 'disabled' : '' %>>
                                                        Cancel
                                                    </button>
                                                <% } %>
                        
                                                <!-- View Details Button -->
                                                <button 
                                                    class="btn btn-secondary" 
                                                    onclick="viewOrderDetails('<%= order._id %>')">
                                                    View Details
                                                </button>
                                            </div>
                                        </div>
                                    <% }) %>
                                <% } else { %>
                                    <p>No orders found.</p>
                                <% } %>
                            </section>
                        </div>
                        
                        <style>
                        
                            .btn-danger {
                                background-color: #dc3545;
                                color: #fff;
                                border: none;
                            }
                        
                            .btn-danger:disabled {
                                background-color: #f5c6cb;
                                cursor: not-allowed;
                            }
                        
                            .btn-primary {
                                background-color: #007bff;
                                color: #fff;
                                border: none;
                            }
                        
                            .btn-primary:disabled {
                                background-color: #cce5ff;
                                cursor: not-allowed;
                            }
                        
                            .btn-secondary {
                                background-color: #6c757d;
                                color: #fff;
                                border: none;
                            }
                        
                            .btn-secondary:hover {
                                background-color: #5a6268;
                            }
                        
                            .order-status {
                                font-weight: bold;
                                color: #333;
                            }
                        </style>
                    </div>         
                </div>       
            </div>     
        </section>

        <script src="assets/js/vendors/jquery-3.6.0.min.js"></script>
        <script src="assets/js/vendors/bootstrap.bundle.min.js"></script>
        <script src="assets/js/vendors/select2.min.js"></script>
        <script src="assets/js/vendors/perfect-scrollbar.js"></script>
        <script src="assets/js/vendors/jquery.fullscreen.min.js"></script>
        <script src="assets/js/main.js?v=1.1" type="text/javascript"></script>

    </body>

    </html>

    <%-include("../../views/partials/user/footer")%>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>

        async function cancelOrder(orderId) {
            try {
                const confirmation = await Swal.fire({
                    title: "Are you sure?",
                    text: "Do you really want to cancel this order?",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: "#d33",
                    cancelButtonColor: "#3085d6",
                    confirmButtonText: "Yes, Cancel",
                    cancelButtonText: "No"
                });
    
                if (confirmation.isConfirmed) {
                    const response = await fetch(`/cancelOrder/${orderId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" }
                    });
    
                    const result = await response.json();
    
                    if (result.success) {
                        await Swal.fire({
                            title: "Order Cancelled",
                            text: "Your order has been Cancelled.",
                            icon: "success"
                        });    
                        window.location.reload();    
                    } else {
                        throw new Error(result.message);
                    }
                }
            } catch (err) {
                console.error('Error canceling order:', err.message);
                await Swal.fire("Oops!", "Internal server error occurred.", "error");
            }
        }
    
        async function returnOrder(orderId) {
            try {
                const confirmation = await Swal.fire({
            title: "Return Order",
            text: "Please provide a reason for returning this item:",
            input: "textarea",
            inputPlaceholder: "Enter your reason here...",
            showCancelButton: true,
            confirmButtonColor: "#28a745",
            cancelButtonColor: "#3085d6",
            confirmButtonText: "Submit",
            cancelButtonText: "Cancel",
            inputValidator: (value) => {
                if (!value) {
                    return "You need to provide a reason!";
                }
            }
        });   
                if (confirmation.isConfirmed) {
                    const reason = confirmation.value;
                    const response = await fetch(`/returnOrder/${orderId}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ reason })
                    });    
                    const result = await response.json();    
                    if (result.success) {
                        await Swal.fire({
                            title: "Requested",
                            text: "Your Return Order Requested" ,
                            icon: "success"
                        });
                        window.location.reload();    
                    } else {
                        throw new Error(result.message);
                    }
                }
            } catch (err) {
                console.error('Error returning order:', err.message);
                await Swal.fire("Oops!", "Internal server error occurred.", "error");
            }
        }
               
        function viewOrderDetails(orderId) {
             window.location.href = `/orderDetails?id=${orderId}`;
         }
     
    </script>